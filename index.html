<!DOCTYPE html>



  


<html class="theme-next mist use-motion" lang="zh-Hans">
<head><meta name="generator" content="Hexo 3.8.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform">
<meta http-equiv="Cache-Control" content="no-siteapp">
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css">







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css">

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="monk, ascetic">










<meta name="description" content="瑶瑶宝宝最可爱">
<meta name="keywords" content="ascetic,monk">
<meta property="og:type" content="website">
<meta property="og:title" content="ascetic">
<meta property="og:url" content="http://yoursite.com/index.html">
<meta property="og:site_name" content="ascetic">
<meta property="og:description" content="瑶瑶宝宝最可爱">
<meta property="og:locale" content="zh-Hans">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="ascetic">
<meta name="twitter:description" content="瑶瑶宝宝最可爱">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Mist',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://yoursite.com/">





  <title>ascetic</title>
  








</head>

<body itemscope="" itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left 
  page-home">
    <div class="headband"></div>

    <header id="header" class="header" itemscope="" itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">ascetic</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">monk</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br>
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br>
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br>
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br>
            
            归档
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2021/06/22/Atomix/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="ascetic">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ascetic">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2021/06/22/Atomix/" itemprop="url">Atomix</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2021-06-22T16:32:46+08:00">
                2021-06-22
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing">
                  <a href="/categories/分布式一致性/" itemprop="url" rel="index">
                    <span itemprop="name">分布式一致性</span>
                  </a>
                </span>

                
                
                  ， 
                
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing">
                  <a href="/categories/分布式一致性/Atomix/" itemprop="url" rel="index">
                    <span itemprop="name">Atomix</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="什么是Atomix"><a href="#什么是Atomix" class="headerlink" title="什么是Atomix"></a>什么是Atomix</h1><p>Atomix是一个支持多种方式来解决分布式问题的通用框架。其不关心所解决的问题，而是通过提供多种分布式的原语来解决问题包括的原语有：</p>
<ol>
<li>分布式数据结构(Map,Set,Tree,技术器,值等)</li>
<li>分布式会话(点对点，发布订阅等)</li>
<li>分布式协调(分布式锁，分布式选举，分布式信号量，分布式barrier(类似于CyclicBarrier))</li>
<li>分组管理</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">AtomicMap&lt;String, String&gt; map = atomix.&lt;String, String&gt;mapBuilder(<span class="string">"my-map"</span>)</span><br><span class="line">  .withCacheEnabled()</span><br><span class="line">  .build();</span><br></pre></td></tr></table></figure>
<p>这些原语中每一个都可以使用不同的分布式协议进行复制，并且根据协议的不同提供不同程度的保证</p>
<ol>
<li><em>Multi-Raft</em> 强一致性的分布式算法</li>
<li><em>Multi-Primary</em> 基于分区leader的同步/异步复制算法</li>
<li><em>Anti-entropy</em> 高度可扩展的最终一致性协议(Gossip协议 )</li>
<li><em>CRDT</em> 最终强一致性复制协议(无冲突的数据的一致性数据处理,Gossip风格)</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">MultiRaftProtocol protocol = MultiRaftProtocol.builder()</span><br><span class="line">  .withReadConsistency(ReadConsistency.LINEARIZABLE)</span><br><span class="line">  .build()</span><br><span class="line">Map&lt;String, String&gt; map = atomix.&lt;String, String&gt;mapBuilder(<span class="string">"my-map"</span>)</span><br><span class="line">  .withProtocol(protocol)</span><br><span class="line">  .withCacheEnabled()</span><br><span class="line">  .build();</span><br><span class="line"></span><br><span class="line">map.put(<span class="string">"foo"</span>, <span class="string">"bar"</span>);</span><br></pre></td></tr></table></figure>
<p>原语是线程安全的、异步的和反应式的，严重依赖事件通知来检测系统中的状态变化</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">LeaderElection&lt;MemberId&gt; election = atomix.getElection(&quot;my-election&quot;);</span><br><span class="line"></span><br><span class="line">election.addListener(event -&gt; &#123;</span><br><span class="line">  Leader leader = event.newLeadership().leader();</span><br><span class="line">  ...</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">election.run(atomix.getMembershipService().getLocalMember().id());</span><br></pre></td></tr></table></figure>
<p>原语支持不同的访问方式:</p>
<ol>
<li>异步api</li>
<li>同步api</li>
<li>REST API</li>
</ol>
<p>原语支持不同的配置方式:</p>
<ol>
<li>Java builders</li>
<li>HOCON 配置</li>
<li>JSON配置</li>
</ol>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/06/26/HashMap/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="ascetic">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ascetic">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/06/26/HashMap/" itemprop="url">HashMap(1.8)</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2020-06-26T16:06:03+08:00">
                2020-06-26
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing">
                  <a href="/categories/java/" itemprop="url" rel="index">
                    <span itemprop="name">java</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="HashMap"><a href="#HashMap" class="headerlink" title="HashMap"></a>HashMap</h2><p>HashMap 由数组+链表+红黑树构成(当当前链表的长度达到8时，并且数组的长度达到64时会将链表转化为红黑树)</p>
<h3 id="HashMap的put过程"><a href="#HashMap的put过程" class="headerlink" title="HashMap的put过程"></a>HashMap的put过程</h3><ol>
<li><p>判断当前整个桶是否为空，如果空的话，进行扩容(叫初始化更准确一些，扩容和初始化公用了resize方法)</p>
</li>
<li><p>如果当前key的hashcode对应的桶的位置为空，直接新建一个node放到该桶上即可</p>
</li>
<li><p>如果当前桶的第一个node的hashcode和equals都返回true那么将该位置的值修改即可</p>
</li>
<li><p>如果当前节点是红黑树的node的话，调用红黑树的添加方法</p>
</li>
<li><p>如果当前节点是链表的话，遍历链表，如果hashcode和equals都返回true的话，修改对应的值,如果找到节点尾部，那么在尾部新建一个节点，并判断是否将链表转化为红黑树</p>
</li>
<li><p>判断是否需要扩容，如果需要进行扩容</p>
</li>
</ol>
<h3 id="tableSizeFor方法解析"><a href="#tableSizeFor方法解析" class="headerlink" title="tableSizeFor方法解析"></a>tableSizeFor方法解析</h3><p>HashMap 在初始化时需要指定initialCapacity(默认16)和loadFactor(默认0.75),initialCapacity在很多规范中建议，为需要初始化数据的1.5倍或者大于等于1.5倍的2的n次方，原因是防止扩容。<br>但是实际上这是没有必要的，在jdk1.8中HashMap中已经解决了该问题，HashMap的tableSizeFor中通过位运算的方式会将一个不是2的n次方的数转换为大于该数的最小的2的n次方数。如果恰好是2的n次方的话那么只要大于该值就可以了。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> n = cap - <span class="number">1</span>;</span><br><span class="line">n |= n &gt;&gt;&gt; <span class="number">1</span>;</span><br><span class="line">n |= n &gt;&gt;&gt; <span class="number">2</span>;</span><br><span class="line">n |= n &gt;&gt;&gt; <span class="number">4</span>;</span><br><span class="line">n |= n &gt;&gt;&gt; <span class="number">8</span>;</span><br><span class="line">n |= n &gt;&gt;&gt; <span class="number">16</span>;</span><br><span class="line"><span class="keyword">return</span> (n &lt; <span class="number">0</span>) ? <span class="number">1</span> : (n &gt;= MAXIMUM_CAPACITY) ? MAXIMUM_CAPACITY : n + <span class="number">1</span>;</span><br></pre></td></tr></table></figure>
<h2 id="ConcurrentHashMap的put过程"><a href="#ConcurrentHashMap的put过程" class="headerlink" title="ConcurrentHashMap的put过程"></a>ConcurrentHashMap的put过程</h2><p>HashMap的基本构造相同，区别是node中value和next被标识为volatile保证数据可见性，CAS + synchronized保证数据可见性。</p>
<ol>
<li><p>如果tab为空初始化数组(通过sizeCtl参数使用CAS方式确保只有一个线程在初始化数组)</p>
</li>
<li><p>如果当前桶是空的，新建一个node，放到该桶的头部，通过CAS算法保证线程安全</p>
</li>
<li><p>如果当前是在扩容中通过helpTransfer并发扩容</p>
</li>
<li><p>如果当前的桶的第一个node等于(hashcode相等并且equals相等)key且不需要更新，则返回该节点</p>
</li>
<li><p>否则对该桶加锁，遍历该链表，如果找到key相等的就更新该位置位置的数据，否则就把该节点放到链表尾部</p>
</li>
<li><p>如果链表长度达到8并且桶的个数大于64会将该列表转化为红黑树。通过synchronized实现同步</p>
</li>
<li><p>计数加1，并且判断是否需要扩容，如果需要扩容，将进行并发扩容</p>
</li>
</ol>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/04/16/redis数据同步机制/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="ascetic">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ascetic">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/04/16/redis数据同步机制/" itemprop="url">redis数据同步机制</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-04-16T14:06:07+08:00">
                2019-04-16
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing">
                  <a href="/categories/多线程/" itemprop="url" rel="index">
                    <span itemprop="name">多线程</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="Redis-全量同步"><a href="#Redis-全量同步" class="headerlink" title="Redis 全量同步"></a>Redis 全量同步</h2><p><strong>发生时机:</strong> slave刚启动初始化时同步</p>
<ol>
<li>slave向master发送SYNC指令，master收到SYNC指令之后将调用syncCommand()进行同步处理</li>
<li>在syncCommand()将调用rdbSaveBackground启动一个备份进程进行数据同步，如果已经有一个备份进程在进行了，就不会在重新启动</li>
<li>备份进程将执行函数rdbSave()完成将redis的全部数据保存到rdb文件</li>
<li>在redis的时间事件函数serverCron（redis的时间处理函数是指它会定时被redis进行操作的函数）中，将对备份后的数据进行处理，在serverCron函数中将会检查备份进程是否已经执行完毕，如果备份进程已经完成备份，则调用函数backgroundSaveDoneHandler完成后续处理。</li>
<li>在函数backgroundSaveDoneHandler中，首先更新master的各种状态，例如，备份成功还是失败，备份的时间等等。然后调用函数updateSlavesWaitingBgsave，将备份的rdb数据发送给等待的slave。</li>
<li>在函数updateSlavesWaitingBgsave中，将遍历所有的等待此次备份的slave，将备份的rdb文件发送给每一个slave。另外，这里并不是立即就把数据发送过去，而是将为每个等待的slave注册写事件，并注册写事件的响应函数sendBulkToSlave，即当slave对应的socket能够发送数据时就调用函数sendBulkToSlave（），实际发送rdb文件的操作都在函数sendBulkToSlave中完成。</li>
<li>sendBulkToSlave函数将把备份的rdb文件发送给slave。</li>
</ol>
<h2 id="Redis-局部同步"><a href="#Redis-局部同步" class="headerlink" title="Redis 局部同步"></a>Redis 局部同步</h2><p><strong>发生时机:</strong> redis发生修改时</p>
<ol>
<li>master接收到一条用户的操作后，将调用函数call函数来执行具体的操作函数，在该函数中首先通过proc执行操作函数，然后将判断操作是否需要扩散到各slave，如果需要则调用函数propagate（）来完成此操作</li>
<li>propagate（）函数完成将一个操作记录到aof文件中或者扩散到其他slave中；在该函数中通过调用feedAppendOnlyFile将操作记录到aof中，通过调用replicationFeedSlaves（）将操作扩散到各slave中。</li>
<li>函数replicationFeedSlaves主要将操作扩散到每一个slave中；在该函数中将遍历自己下面挂的每一个slave，以此对每个slave进行如下两步的处理：将slave的数据库切换到本操作所对应的数据库（如果slave的数据库id与当前操作的数据id不一致时才进行此操作）；将命令和参数按照redis的协议格式写入到slave的缓存中。写入切换数据库的命令时将调用addReply，写入命令和参数时将调用addReplyMultiBulkLen和addReplyBulk，函数addReplyMultiBulkLen和addReplyBulk最终也将调用函数addReply</li>
<li>在函数addReply中将调用prepareClientToWrite（）设置slave的socket写入事件处理函数sendReplyToClient（通过函数aeCreateFileEvent进行设置），这样一旦slave对应的socket发送缓存中有空间写入数据，即调用sendReplyToClient进行处</li>
</ol>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/04/16/垃圾收集器/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="ascetic">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ascetic">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/04/16/垃圾收集器/" itemprop="url">垃圾收集器</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-04-16T14:06:07+08:00">
                2019-04-16
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing">
                  <a href="/categories/JVM/" itemprop="url" rel="index">
                    <span itemprop="name">JVM</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="垃圾收集器"><a href="#垃圾收集器" class="headerlink" title="垃圾收集器"></a>垃圾收集器</h2><p>按照分代区分为老年代收集器和新生代收集器。年轻代收集器包含:<strong>Serial</strong>、<strong>ParNew</strong> 、<strong>Parallel Scavenge</strong>、<strong>G1</strong> ;老年代收集器有:<strong>CMS</strong>、<strong>Serial Old(MSC)</strong> 、<strong>Parallel Old</strong>、<strong>G1</strong> 。G1 收集器既能收集新生代也能收集老年代。</p>
<h3 id="Serial-收集器"><a href="#Serial-收集器" class="headerlink" title="Serial 收集器"></a>Serial 收集器</h3><p>Serial 是一个新生代收集器，单线程工作，使用复制算法。当垃圾收集时其他的所有线程都处于暂停状态(Stop The World)，优点：简单高效。</p>
<h3 id="ParNew-收集器"><a href="#ParNew-收集器" class="headerlink" title="ParNew 收集器"></a>ParNew 收集器</h3><p>ParNew 是Serial 收集器的多线程版本，使用复制算法。在Serail的基础上增加了多线程垃圾收集。</p>
<h3 id="Parallel-Scavenge-收集器"><a href="#Parallel-Scavenge-收集器" class="headerlink" title="Parallel Scavenge 收集器"></a>Parallel Scavenge 收集器</h3><p>Parallel Scavenge 是一个新生代多线程收集器，使用复制算法。收集器的目标是达到一个可以控制的吞吐量。</p>
<h3 id="Serial-Old"><a href="#Serial-Old" class="headerlink" title="Serial Old"></a>Serial Old</h3><p>Serial 收集器的老年代版本，单线程，使用标记整理算法。</p>
<h3 id="Parallel-Old"><a href="#Parallel-Old" class="headerlink" title="Parallel Old"></a>Parallel Old</h3><p>Parallel Old 收集器是 Serial Old的多线程版本，使用标记整理算法。</p>
<h3 id="CMS-收集器"><a href="#CMS-收集器" class="headerlink" title="CMS 收集器"></a>CMS 收集器</h3><p>CMS 是老年代，多线程，使用标记清除算法的收集器，其主要目标是一种以获取最短回收停顿时间为目标的收集器。</p>
<p>其过程分为四个步骤:</p>
<ol>
<li>初始标记</li>
<li>并发标记</li>
<li>重新标记</li>
<li>并发清除</li>
</ol>
<p>其中，初始标记、重新标记着两个步骤仍然需要”Stop The World”。初始标记仅仅标记一下GC Roots能直接关联到的对象，速度很快。并发标记阶段就是进行GC Roots Tracing 的过程，而重新标记阶段则是为了修正并发标记期间因用户程序继续运作而导致标记产生变动的那一部分对象的标记记录。这个阶段的停顿时间一般会比初始化标记阶段稍长一些。但是远比并发标记的时间短。</p>
<p>CMS 的优点：</p>
<ol>
<li>并发收集</li>
<li>低停顿</li>
</ol>
<p>CMS 的缺点:</p>
<ol>
<li>CMS收集器对CPU资源敏感。并发阶段会降低吞吐量。</li>
<li>CMS 收集器无法处理浮动垃圾</li>
<li>标记清除算法会产生大量空间碎片</li>
</ol>
<h3 id="G1"><a href="#G1" class="headerlink" title="G1"></a>G1</h3><ol>
<li>并行与并发：G1 能充分利用CPU、多核环境下的硬件优势、使用多个CPU来缩短 Stop The World 的时间。</li>
<li>分代收集</li>
<li>空间整合 从整体上看基于标记整理，局部为复制算法。</li>
<li>可预测的停顿时间。</li>
</ol>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/03/20/判断对象是否已死/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="ascetic">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ascetic">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/03/20/判断对象是否已死/" itemprop="url">垃圾回收算法</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-03-20T10:19:56+08:00">
                2019-03-20
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing">
                  <a href="/categories/JVM/" itemprop="url" rel="index">
                    <span itemprop="name">JVM</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="对象是否已死检测策略"><a href="#对象是否已死检测策略" class="headerlink" title="对象是否已死检测策略"></a>对象是否已死检测策略</h2><p>垃圾回收时需要判断什么样的对象才是已死的呢，主要有两种方法，引用计数法和可达性分析算法。</p>
<h3 id="引用计数算法"><a href="#引用计数算法" class="headerlink" title="引用计数算法"></a>引用计数算法</h3><p>给对象添加一个引用计数器，每当一个对象被引用时，计数器加1；当引用失效时，计数器就减1；任何时刻计数器为0的对象就是不可能再被使用的。客观而言引用计数法实现简单效率也高，在大部分情况下它都是一个不错的算法。但是主流的JVM里没有选用引用计数法来管理内存，<strong>其很难解决循环引用的问题</strong>。</p>
<h3 id="可达性分析算法"><a href="#可达性分析算法" class="headerlink" title="可达性分析算法"></a>可达性分析算法</h3><p>通过一些列GC Roots 的对象作为起始点，从这些节点开始向下搜索，搜索所有走过的引用链，当一个对象到GC Roots没有任何引用链相连时，则对象是不可引用的，则可以判定为可回收对象。</p>
<h4 id="GC-Roots的对象包括下面几种"><a href="#GC-Roots的对象包括下面几种" class="headerlink" title="GC Roots的对象包括下面几种:"></a>GC Roots的对象包括下面几种:</h4><p>虚拟机栈中引用的对象<br>方法区中类静态属性引用的对象<br>方法区中常量引用的对象<br>本地方法栈中JNI(即一般说的native方法)引用的对象。</p>
<h2 id="再谈引用"><a href="#再谈引用" class="headerlink" title="再谈引用"></a>再谈引用</h2><p>强引用：类似 “Object obj = new Object()” 这类的引用，只要强引用还存在，垃圾收集器永远不会回收掉呗引用的对象</p>
<p>软引用：用来描述一些还有用但并非必须的对象。对于软引用在系统要发生内存溢出之前，将会对这类对象进行第二次回收，如果回收后仍然内存不够，才会抛出内存溢出异常。在JDK1.2之后，提供了SoftReference类来实现软引用。</p>
<p>弱引用：用来描述非必须的对象，但是它的强度比软引用更弱一些，被弱引用关联的对象只能生存到下一次垃圾收集发生之前。当垃圾收集器工作时，无论当前内存是否足够，都会回收掉只被弱引用关联的对象。在JDK1.2之后，提供了WeakReference类来实现弱引用。</p>
<p>虚引用：虚引用也称为幽灵引用或者幻影引用，它是最弱的一种引用关系。一个对象是否有虚引用的存在，完全不对其生存时间构成影响，也无法通过徐引用来取得一个对象实例。对一个对象设置虚引用的唯一目的就是能在这个对象收集器回收时收到一个系统通知。在JDK1.2之后，提供PhantomReference。</p>
<h2 id="垃圾收集算法"><a href="#垃圾收集算法" class="headerlink" title="垃圾收集算法"></a>垃圾收集算法</h2><h3 id="标记清除算法"><a href="#标记清除算法" class="headerlink" title="标记清除算法"></a>标记清除算法</h3><p>该算法分为两个阶段:”标记”和”清除”两个过程。其不足主要有两个问题：<strong>1）效率问题,标记和清除两个过程的效率都不高。2）标记清除之后会产生大量不连续的内存碎片</strong></p>
<h3 id="复制算法"><a href="#复制算法" class="headerlink" title="复制算法"></a>复制算法</h3><p>他将可用的区域按照容量发呢为大小相等的两块，每次只使用其中一块。当这块的内存用完了，就将还存活的对象复制到另外一块上面，然后再把使用过得内存空间清理一次。这样每次都是对半区进行内存回收。内存也不用考虑内存碎片等复杂情况只要已动工堆顶指针按照顺序分配即可。优点:<strong>实现简单，运行高效</strong>,缺点:<strong>空间换时间</strong></p>
<h3 id="标记整理算法"><a href="#标记整理算法" class="headerlink" title="标记整理算法"></a>标记整理算法</h3><p>同样分为两个过程:<strong>标记</strong>和<strong>整理</strong> 标记过程同标记清楚算法一样，但后续步骤不是直接对可回收对象进行清理，而是让所有存活的对象都向一端移动，然后直接清理掉边界以外的内存。</p>
<h3 id="分代收集算法"><a href="#分代收集算法" class="headerlink" title="分代收集算法"></a>分代收集算法</h3><p>新生代朝生夕死就采用复制算法，只需要付出很少存活对象的复制成本就可以完成收集。而老年代中因为对象存活率高，没有额外空间对他进行担保就必须使用标记清除或者标记整理算法来进行空间回收。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/03/18/jVM内存模型/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="ascetic">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ascetic">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/03/18/jVM内存模型/" itemprop="url">java虚拟机运行时数据区</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-03-18T17:39:32+08:00">
                2019-03-18
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing">
                  <a href="/categories/JVM/" itemprop="url" rel="index">
                    <span itemprop="name">JVM</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="java虚拟机运行时区域"><a href="#java虚拟机运行时区域" class="headerlink" title="java虚拟机运行时区域"></a>java虚拟机运行时区域</h2><img src="http://www.plantuml.com/plantuml/svg/AyxEp2j8B4hCLIXAJIv9p4lFILMevk8ioY_DIt7EByfBBL8mCkMgvKB8AhtOF-75mfvdqxSzcxhXMU-wfpsxbC1Q42gUxzh_V4NtorbJdY_RZL04L8EiwCNCMS-wvp-Ri-lPWewOl31VXU2InEHi9ULm3yyGLrIbp-QiUJfdmxDfEvzjdWfMxPTOabcMgk2RMfAHduAgKG4Aa9spellfhluNwnO2tV9qvegOl82Y_7IGbvs1lYm1-Z0eDJsp6CX0DgEM2zqKiAUUjcvyiciragU0Yb0T-tH1MqoUWaTgOe6IiazcUaQ9Ur5Y9Pf_m3u1QWSgXFh1iIWr4Lazn0cr0000">
<h2 id="程序计数器"><a href="#程序计数器" class="headerlink" title="程序计数器"></a>程序计数器</h2><p>程序计数器是当前线程所执行的字节码的行号指示器，字节码解释器工作时就是通过改变这个计数器的值来选取下一条需要执行的字节码指令。该计数器线程切换时相互不影响，所以这类区域为<strong>”线程私有“</strong>内存。如果线程执行的是一个java方法，计数器记录的是正在执行的虚拟机字节码指令的地址；如果执行的是一个native方法，这个计数器则为空(Undefined)。此区域是唯一一个在java虚拟机规范中没有规定OutOfMemoryError情况的区域。</p>
<h2 id="虚拟机栈"><a href="#虚拟机栈" class="headerlink" title="虚拟机栈"></a>虚拟机栈</h2><p>Java虚拟机栈是线程私有的，它的生命周期与线程相同。此虚拟机栈描述的Java方法执行的内存模型：每个方法在执行的同时创建一个栈帧用于存储局部变量表、操作数栈、动态链接、方法调用出口等。每一个方法从调用直至执行完成的过程，就对应着一个栈帧在虚拟机栈中入栈到出站的过程。当线程请求的栈深度大于虚拟机栈允许的深度，会抛出StackOverflowError。当无法申请到内存时会抛出OutOfMemoryError异常。</p>
<h2 id="本地方法栈"><a href="#本地方法栈" class="headerlink" title="本地方法栈"></a>本地方法栈</h2><p>本地方法栈与虚拟栈所发挥的作用是非常相似的，它们之间区别是虚拟机栈为java方法服务，而本地方法栈为native方法服务。</p>
<h2 id="堆"><a href="#堆" class="headerlink" title="堆"></a>堆</h2><p>堆是被所有线程共享的区域，在虚拟机启动时创建。对于大多数应用来说，java堆是java虚拟机锁管理的内存中最大的一块。此内存唯一的目的就是存放对象实例，几乎所有的对象实例都在这里分配。堆是垃圾收集器管理的主要区域，因此很多时候也称为”GC堆”。堆可以处于不连续的内存空间中，只要逻辑连续即可。主流的虚拟机都可以可扩展的.(通过-Xmx 和-Xms控制)。</p>
<h2 id="方法区-非堆"><a href="#方法区-非堆" class="headerlink" title="方法区(非堆)"></a>方法区(非堆)</h2><p>方法区也是线程共享的区域，是各个线程共享的内存区域，它用于存储已经被虚拟机加载的类信息，常量、静态常量、即时编译后的代码数据。</p>
<h2 id="运行时常量池"><a href="#运行时常量池" class="headerlink" title="运行时常量池"></a>运行时常量池</h2><p>运行时常量池是方法区的一部分。Class文件中除了有类的版本、字段、方法、接口等还有一想信息是常量池。用于存放编译器生成的字面量和符号引用这部分内容将在类加载后进入方法区的运行时常量池。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/03/01/类加载机制/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="ascetic">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ascetic">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/03/01/类加载机制/" itemprop="url">类加载机制</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-03-01T15:08:48+08:00">
                2019-03-01
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing">
                  <a href="/categories/JVM/" itemprop="url" rel="index">
                    <span itemprop="name">JVM</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="类加载过程"><a href="#类加载过程" class="headerlink" title="类加载过程"></a>类加载过程</h2><img src="http://www.plantuml.com/plantuml/svg/AyxEp2j8B4hCLSZDpyjFpYZApqrLA2agJUMoUjgruCNUlTPSLY_sptlMjrJZvQgU5-iRt-_fUThUzdH9Ev3nOldYP_CcQ0ALFEsO-tHvzzEUQTOA0000">
<h3 id="加载"><a href="#加载" class="headerlink" title="加载"></a>加载</h3><p>查找并加载类的二进制数据。在该阶段虚拟机需要完成3件事情:</p>
<p>1.​通过一个类的全限定名来获取类定义此类的二进制流。</p>
<p>2.​将这个字节流所代表的静态存储结构转化为方法区的运行时数据结构。</p>
<p>3.​在内存(堆区)中生成一个代表这个类的java.lang.Class 对象，作为方法区这个类的各种数据的访问入口。</p>
<h3 id="连接"><a href="#连接" class="headerlink" title="连接"></a>连接</h3><p>连接是将已经读入内存的类的二进制数据合并到虚拟机的运行时环境中去。</p>
<h4 id="验证"><a href="#验证" class="headerlink" title="验证"></a>验证</h4><p>​确保被加载的类的正确性。验证过程主要分为4个阶段分别为：文件格式校验、元数据校验，字节码校验、符号引用验证。</p>
<h4 id="准备"><a href="#准备" class="headerlink" title="准备"></a>准备</h4><p>​为类的静态变量分配内存，并将赋予默认值，例如:该阶段value的初始值为0，该阶段为value赋值为0，而不是123。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">int</span> value=<span class="number">123</span>;</span><br></pre></td></tr></table></figure>
<h4 id="解析"><a href="#解析" class="headerlink" title="解析"></a>解析</h4><p>​解析阶段是虚拟机将常量池内的符号引用替换为直接引用的过程。该阶段可能发生在初始化之前也可能发生在初始化阶段之后。</p>
<h3 id="初始化"><a href="#初始化" class="headerlink" title="初始化"></a>初始化</h3><p>​为类的静态变量赋予正确的初始值。如上例子中:该阶段才完成value赋值为123。</p>
<p>类初始化时机有且只有以下五种情况:</p>
<p>1.遇到new (新建对象时),getstatic(读取静态变量时),putstatic(写一个的静态变量)或invokestatic(调用静态方法时)这4条字节码指令时。</p>
<p>2.使用java.lang.reflect 包的方法对类进行反射调用的时候。</p>
<p>3.当初始化一个类的时候，如果发现父类还没有初始化，则先需要先触发器父类的初始化。</p>
<p>4.当虚拟机启动时，用户需要制定一个执行的主类(main 方法所在类)，虚拟机会先初始化这个类。</p>
<p>5、动态语言支持中,如果一个java.lang.invoke.MethodHandler实例返回的戒指结果REF_getStatic、REF_putStatic、REF_invokeStatic的方法句柄，并且这个方法句柄所对应的类没有进行过初始化，则需要先触发其初始化。</p>
<h2 id="类加载器的分类"><a href="#类加载器的分类" class="headerlink" title="类加载器的分类"></a>类加载器的分类</h2><p>从Java虚拟机的角度来讲，只存在两种不同的类加载器: 一种是启动类加载器，这个类加载器使用C++语言实现，是虚拟机的一部分；另一种就是所有的其他的类加载器，这些类加载器都由Java语言实现，独立于虚拟机外部，并且全部都技能自抽象类java.lang,ClassLoader。</p>
<h3 id="java虚拟机自带的加载器"><a href="#java虚拟机自带的加载器" class="headerlink" title="java虚拟机自带的加载器"></a>java虚拟机自带的加载器</h3><h4 id="启动类加载器（Bootstrap）"><a href="#启动类加载器（Bootstrap）" class="headerlink" title="启动类加载器（Bootstrap）"></a>启动类加载器（Bootstrap）</h4><p>这个加载器负责将&lt;JAVA_HOMT&gt;\lib 目录中的，或者被-Xbootclasspath参数所指定的路径中的并且是虚拟机识别的类库加载到虚拟机内存中。程序员无法再java代码中获取该类。</p>
<h4 id="扩展类加载器（Extension）"><a href="#扩展类加载器（Extension）" class="headerlink" title="扩展类加载器（Extension）"></a>扩展类加载器（Extension）</h4><p>j这个加载器由sun.misc.Launcher$ExtClassLoader实现，负责加载&lt;JAVA_HOME&gt;\lib\ext 目录中的，或者被java.ext.dirs系统变量所指定的路径中的所有类库,开发者可以直接使用扩展类加载器</p>
<h4 id="应用加载器（System）"><a href="#应用加载器（System）" class="headerlink" title="应用加载器（System）"></a>应用加载器（System）</h4><p>这个加载器有sun.misc.Launcher$App-ClassLoader实现。由于该类加载器是ClassLoader中的getSystemClassLoader()方法的返回值，所以一般也成为系统类加载器。它负责加载用户类路径(ClassPath)上所指定的类库。所以开发者可以直接使用这个类加载器，如果应用程序中没有自定义自己的类加载器，一般情况下这个就是程序中默认的类加载器。</p>
<h3 id="用户自定义的类加载器"><a href="#用户自定义的类加载器" class="headerlink" title="用户自定义的类加载器"></a>用户自定义的类加载器</h3><p>用户自定义类加载器，必须是java.lang.ClassLoader的子类，可以定义类的加载行为。</p>
<h2 id="双亲委派模型"><a href="#双亲委派模型" class="headerlink" title="双亲委派模型"></a>双亲委派模型</h2><img src="http://www.plantuml.com/plantuml/svg/AyxEp2j8B4hCLSZDpyjFpYZApqrLA2agJUNIU3fX_TEk5SytxdxQjU35thrFPww8oNFApoyfBaaiK73EIImkzibFJ4ajqhJHrTLurhdowSQfg8fTAqfIyuepy_DGL7EHe1PayjDTKvvFMV5yHVVJNVseUXmB2d8oanDBC6qWNG_8fXVjgvwkc_LaPoUo5iEOlD3Yr2A8uXmQM624nG80">
<p>双亲委派模型要求除了顶层的启动类加载外，其余的类加载器都应当有自己的父类加载器，这里类加载器的父子关系一般不会以继承(Inheritance)的关系来实现，而是都使用组合(Cpmposition)关系来复用附加在其的代码 。</p>
<h3 id="双亲委派模型的工作过程"><a href="#双亲委派模型的工作过程" class="headerlink" title="双亲委派模型的工作过程"></a>双亲委派模型的工作过程</h3><p>如果一个类加载器收到类加载的请求，它首先不会自己去尝试加载这个类，而是把这个请求委派给父类加载器去完成，每一个层次都是如此，因此所有的加载请求最终都应该传送到顶层的启动类加载器中，只有当父类加载器反馈自己无法完成这个请求时，子加载器才会去尝试自己去加载。双亲委派模型的好处是：<strong>能够有效确保一个类的全局唯一性</strong>。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/01/25/多线程-基本概念/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="ascetic">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ascetic">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/01/25/多线程-基本概念/" itemprop="url">多线程-基本概念</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-01-25T11:18:24+08:00">
                2019-01-25
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing">
                  <a href="/categories/多线程/" itemprop="url" rel="index">
                    <span itemprop="name">多线程</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>多线程</p>
<h2 id="重入"><a href="#重入" class="headerlink" title="重入"></a>重入</h2><p>当某个线程请求一个由其他线程获取持有的锁时，该线程就会阻塞。然而，由于synchronized是可重入的，因此如果某个锁线程获取一个已经由它自己持有的锁时，这个请求就会成功。重入意味着获取锁的粒度是线程而不是调用。</p>
<p>重入的一种方法是，给锁关联一个计数器和一个持有者线程。当计数器为0时说明该线程未被线程持有。当线程请求一个未持有的锁时，JVM将记下锁的持有者并且将计数值设置为1，如果同一线程再次访问时将计数器加1，当同一线程退出同步代码块时，计数器减1，当技术器为0时，该锁将被释放。</p>
<h2 id="volatile"><a href="#volatile" class="headerlink" title="volatile"></a>volatile</h2><p>当变量被声明为volatile类型后，编译器与运行时都会注意到这个变量是共享的，因此不会将该变量上的操作与其他内存操作一起重排序。volatile变量不会被缓存在寄存器或者对其他处理器不可见的地方,因此在读取volatile类型的变量时总会返回最新写入的值。</p>
<h2 id="synchronized实现原理"><a href="#synchronized实现原理" class="headerlink" title="synchronized实现原理"></a>synchronized实现原理</h2><p>synchronized 同步语句块使用的是monitorenter和monitorexit指令，其中monitorenter指令指向同步代码块的开始位置，monitorexit指令则指明同步代码块的结束位置。<br>synchronized 修饰方法使用的是ACC_SYNCHRONIZED 标识</p>
<h2 id="ReentrantLock实现原理"><a href="#ReentrantLock实现原理" class="headerlink" title="ReentrantLock实现原理"></a>ReentrantLock实现原理</h2><p>ReentrantLock 通过AbstractQueuedSynchronizer(即AQS)实现.用FIFO队列实现公平锁和非公平锁，在公平锁中，如果当另一个线程持有锁或者有其他线程在等待队列中这个锁，所以新发出的请求的线程将被放入到度一列中。而非公平锁，只有当锁被其他线程持有时，新发出请求的线程才会被放入队列中(此时和公平锁是一样的)。所以他们的差别是非公平锁会有更多的机会去抢占锁。</p>
<h2 id="ReenTrantLock的对比"><a href="#ReenTrantLock的对比" class="headerlink" title="ReenTrantLock的对比"></a>ReenTrantLock的对比</h2><p>1、两者都是可重入锁</p>
<p>2、synchronized依赖于JVM而ReenTrantLock依赖于API</p>
<p>3、ReenTrantLock比synchronized增加了一些高级功能主要有:<strong>等待可中断</strong>、<strong>可实现公平锁</strong>、<strong>可实现选择性通知</strong></p>
<ol>
<li><strong>ReenTrantLock提供了一种能够中断等待锁的线程机制</strong>，通过lock.lockInterruptibly()来实现这个机制。</li>
<li><strong>ReenTrantLock 可以指定公平锁和非公平锁,而synchronized只能是非公平锁</strong>。所谓的公平锁就是先等待的线程先获得锁。ReenTrantLock默认情况是公平的。</li>
<li><strong>synchronized关键字与wait()和notify/notifyAll()方法相结合可以实现等待/通知机制，ReentrantLock类当然也可以实现，但是需要借助于Condition接口与newCondition() 方法。Condition是JDK1.5之后才有的，它具有很好的灵活性，比如可以实现多路通知功能也就是在一个Lock对象中可以创建多个Condition实例（即对象监视器），线程对象可以注册在指定的Condition中，从而可以有选择性的进行线程通知，在调度线程上更加灵活。 在使用notify/notifyAll()方法进行通知时，被通知的线程是由 JVM 选择的，用ReentrantLock类结合Condition实例可以实现“选择性通知”。</strong></li>
</ol>
<h2 id="AQS实现原理"><a href="#AQS实现原理" class="headerlink" title="AQS实现原理"></a>AQS实现原理</h2><p>AQS核心思想是，如果请求的共享资源空闲，则将当前请求资源的线程设置为有效的工作线程，并且将共享资源设置为锁定状态。如果被请求的共享资源占用，那么需要一套线程阻塞等待以及被唤醒时锁分配的机制，这个机制是AQS是用CLH(FIFO双向队列)队列锁实现的，即将暂时获取不到的线程加入到队列中。</p>
<h2 id="AQS定义两种资源共享方式"><a href="#AQS定义两种资源共享方式" class="headerlink" title="AQS定义两种资源共享方式"></a>AQS定义两种资源共享方式</h2><p>Exclusive(独占)；只有一个线程能执行如ReentrantLock.又可分为公平锁和非公平锁:</p>
<ol>
<li>按照线程在队列中的排队顺序，先到者先拿到锁 </li>
<li>当线程要获取锁时，无视队列顺序直接去抢锁，谁抢到就是谁的<br>Share（共享）：多个线程可同时执行，如Semaphore/CountDownLatch。Semaphore、CountDownLatch、 CyclicBarrier、ReadWriteLock。</li>
</ol>
<h3 id="AQS使用了模板方法模式，自定义同步器时需要重写下面几个AQS提供的模板方法："><a href="#AQS使用了模板方法模式，自定义同步器时需要重写下面几个AQS提供的模板方法：" class="headerlink" title="AQS使用了模板方法模式，自定义同步器时需要重写下面几个AQS提供的模板方法："></a>AQS使用了模板方法模式，自定义同步器时需要重写下面几个AQS提供的模板方法：</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">isHeldExclusively()<span class="comment">//该线程是否正在独占资源。只有用到condition才需要去实现它。</span></span><br><span class="line">tryAcquire(<span class="keyword">int</span>)<span class="comment">//独占方式。尝试获取资源，成功则返回true，失败则返回false。</span></span><br><span class="line">tryRelease(<span class="keyword">int</span>)<span class="comment">//独占方式。尝试释放资源，成功则返回true，失败则返回false。</span></span><br><span class="line">tryAcquireShared(<span class="keyword">int</span>)<span class="comment">//共享方式。尝试获取资源。负数表示失败；0表示成功，但没有剩余可用资源；正数表示成功，且有剩余资源。</span></span><br><span class="line">tryReleaseShared(<span class="keyword">int</span>)<span class="comment">//共享方式。尝试释放资源，成功则返回true，失败则返回false。</span></span><br></pre></td></tr></table></figure>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/01/24/自定义泛型TypeHandler的使用/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="ascetic">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ascetic">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/01/24/自定义泛型TypeHandler的使用/" itemprop="url">自定义泛型TypeHandler的使用</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-01-24T15:26:43+08:00">
                2019-01-24
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing">
                  <a href="/categories/mybatis/" itemprop="url" rel="index">
                    <span itemprop="name">mybatis</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="泛型TypeHandler的使用"><a href="#泛型TypeHandler的使用" class="headerlink" title="泛型TypeHandler的使用"></a>泛型TypeHandler的使用</h2><p>在上一篇博客中讲述了,TypeHandler的基本使用。但是对于某些结构对应多种类型。例如数据库字段为json结构，映射对象字段为自定义类型，那么难道到每种类型都要分别做处理吗？接下里稍作改造typeHandler，就可以完美适配。</p>
<h3 id="1、将TypeHandler改为泛型的TypeHandler"><a href="#1、将TypeHandler改为泛型的TypeHandler" class="headerlink" title="1、将TypeHandler改为泛型的TypeHandler"></a>1、将TypeHandler改为泛型的TypeHandler</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">JsonbTypeHandler&lt;T&gt; extends BaseTypeHandler&lt;T&gt;</span><br></pre></td></tr></table></figure>
<h3 id="2、给该类添加参数type并添加构造函数"><a href="#2、给该类添加参数type并添加构造函数" class="headerlink" title="2、给该类添加参数type并添加构造函数"></a>2、给该类添加参数type并添加构造函数</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">private</span> Class&lt;T&gt; type;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">JsonbTypeHandler</span><span class="params">(Class&lt;T&gt; type)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (type == <span class="keyword">null</span>) <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"Type argument cannot be null"</span>);</span><br><span class="line">        <span class="keyword">this</span>.type = type;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<h3 id="3、添加映射类型"><a href="#3、添加映射类型" class="headerlink" title="3、添加映射类型"></a>3、添加映射类型</h3><p>每次添加需要映射的类型，只要在@MappedTypes注解中添加需要映射的类型就可以了</p>
<p>完整的带泛型的TypeHandler代码如下<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@MappedJdbcTypes</span>(value = &#123;JdbcType.OTHER&#125;, includeNullJdbcType = <span class="keyword">true</span>)</span><br><span class="line"><span class="meta">@MappedTypes</span>(&#123; A.class , B[].class&#125;)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">JsonbTypeHandler</span>&lt;<span class="title">T</span>&gt; <span class="keyword">extends</span> <span class="title">BaseTypeHandler</span>&lt;<span class="title">T</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Logger logger = LoggerFactory.getLogger(getClass());</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> ObjectMapper objectMapper = <span class="keyword">new</span> ObjectMapper();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Class&lt;T&gt; type;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">JsonbTypeHandler</span><span class="params">(Class&lt;T&gt; type)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (type == <span class="keyword">null</span>) <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"Type argument cannot be null"</span>);</span><br><span class="line">        <span class="keyword">this</span>.type = type;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 设置非空参数</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> ps             PreparedStatement</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> parameterIndex 参数</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> parameter      参数数组</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> jdbcType       jdbcType</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> SQLException</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setNonNullParameter</span><span class="params">(PreparedStatement ps, <span class="keyword">int</span> parameterIndex, T parameter, JdbcType jdbcType)</span></span></span><br><span class="line"><span class="function">            <span class="keyword">throws</span> SQLException </span>&#123;</span><br><span class="line">        String jsonText;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            jsonText = objectMapper.writeValueAsString(parameter);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (JsonProcessingException e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(e);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        ps.setString(parameterIndex, jsonText);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获取可以为null的结果集</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> resultSet  结果集</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> columnName 列名</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> T <span class="title">getNullableResult</span><span class="params">(ResultSet resultSet, String columnName)</span> <span class="keyword">throws</span> SQLException </span>&#123;</span><br><span class="line">        String jsonText = resultSet.getString(columnName);</span><br><span class="line">        <span class="keyword">return</span> readToObject(jsonText);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获取可以为null的结果集</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> resultSet   结果集</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> columnIndex columnIndex 列标</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> T <span class="title">getNullableResult</span><span class="params">(ResultSet resultSet, <span class="keyword">int</span> columnIndex)</span> <span class="keyword">throws</span> SQLException </span>&#123;</span><br><span class="line">        String jsonText = resultSet.getString(columnIndex);</span><br><span class="line">        <span class="keyword">return</span> readToObject(jsonText);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获取可以为null的结果集</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> callableStatement CallableStatement</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> columnIndex       列号</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> T <span class="title">getNullableResult</span><span class="params">(CallableStatement callableStatement, <span class="keyword">int</span> columnIndex)</span> <span class="keyword">throws</span> SQLException </span>&#123;</span><br><span class="line">        String jsonText = callableStatement.getString(columnIndex);</span><br><span class="line">        <span class="keyword">return</span> readToObject(jsonText);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> T <span class="title">readToObject</span><span class="params">(String jsonText)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (StringUtils.isEmpty(jsonText)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            T list = objectMapper.readValue(jsonText, type);</span><br><span class="line">            <span class="keyword">return</span>  list;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            logger.error(<span class="string">"字符串反序列化失败字符串为&#123;&#125;"</span>,jsonText,e);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/01/23/自定义typeHandler的使用/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="ascetic">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ascetic">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/01/23/自定义typeHandler的使用/" itemprop="url">自定义typeHandler的使用</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-01-23T11:38:17+08:00">
                2019-01-23
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing">
                  <a href="/categories/mybatis/" itemprop="url" rel="index">
                    <span itemprop="name">mybatis</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="简单TypeHandler-的使用"><a href="#简单TypeHandler-的使用" class="headerlink" title="简单TypeHandler 的使用"></a>简单TypeHandler 的使用</h2><p>mybatis是一个常用的一个ORM框架，但是mybatis提供的TypeHandler往往是不够用的，例如某些数据库支持json、数组等的支持，但是mybatis对于这些数据类型没有支持，接下来就需要我们自定义TypeHandler了。</p>
<h3 id="1、创建TypeHandler类继承BaseTypeHandler。"><a href="#1、创建TypeHandler类继承BaseTypeHandler。" class="headerlink" title="1、创建TypeHandler类继承BaseTypeHandler。"></a>1、创建TypeHandler类继承BaseTypeHandler。</h3><p>下面是一个针对数组类型的TypeHandler，并实现方法<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br></pre></td><td class="code"><pre><span class="line">public class ArrayTypeHandler extends BaseTypeHandler&lt;Object[]&gt; &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String TYPE_NAME_VARCHAR = <span class="string">"varchar"</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String TYPE_NAME_INTEGER = <span class="string">"integer"</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String TYPE_NAME_BOOLEAN = <span class="string">"boolean"</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String TYPE_NAME_NUMERIC = <span class="string">"numeric"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Logger logger = LoggerFactory.getLogger(<span class="keyword">this</span>.getClass());</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 设置非空参数</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> ps             PreparedStatement</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> parameterIndex 参数i</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> parameter      参数数组</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> jdbcType       jdbcType</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> SQLException</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setNonNullParameter</span><span class="params">(PreparedStatement ps, <span class="keyword">int</span> parameterIndex, Object[] parameter, JdbcType jdbcType)</span> <span class="keyword">throws</span> SQLException </span>&#123;</span><br><span class="line">        String typeName = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">if</span> (parameter <span class="keyword">instanceof</span> Integer[]) &#123;</span><br><span class="line">            typeName = TYPE_NAME_INTEGER;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (parameter <span class="keyword">instanceof</span> String[]) &#123;</span><br><span class="line">            typeName = TYPE_NAME_VARCHAR;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (parameter <span class="keyword">instanceof</span> Boolean[]) &#123;</span><br><span class="line">            typeName = TYPE_NAME_BOOLEAN;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (parameter <span class="keyword">instanceof</span> Double[]) &#123;</span><br><span class="line">            typeName = TYPE_NAME_NUMERIC;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (typeName == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> TypeException(<span class="string">"ArrayTypeHandler parameter typeName error, your type is "</span> + parameter.getClass().getName());</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 这3行是关键的代码，创建Array，然后ps.setArray(parameterIndex, array)就可以了</span></span><br><span class="line">        Connection conn = ps.getConnection();</span><br><span class="line">        Array array = conn.createArrayOf(typeName, parameter);</span><br><span class="line">        ps.setArray(parameterIndex, array);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获取可以为null的结果集</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> resultSet  结果集</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> columnName 列名</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Object[] getNullableResult(ResultSet resultSet, String columnName) <span class="keyword">throws</span> SQLException &#123;</span><br><span class="line">        <span class="keyword">return</span> getArray(resultSet.getArray(columnName));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获取可以为null的结果集</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> resultSet   结果集</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> columnIndex columnIndex 列标</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Object[] getNullableResult(ResultSet resultSet, <span class="keyword">int</span> columnIndex) <span class="keyword">throws</span> SQLException &#123;</span><br><span class="line">        <span class="keyword">return</span> getArray(resultSet.getArray(columnIndex));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获取可以为null的结果集</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> callableStatement CallableStatement</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> paramIndex        列号</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Object[] getNullableResult(CallableStatement callableStatement, <span class="keyword">int</span> paramIndex) <span class="keyword">throws</span> SQLException &#123;</span><br><span class="line">        <span class="keyword">return</span> getArray(callableStatement.getArray(paramIndex));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 将ARRAY 转为 java数组</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> array 数组</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Object[] getArray(Array array) &#123;</span><br><span class="line">        <span class="keyword">if</span> (array == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> (Object[]) array.getArray();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            logger.error(<span class="string">"ARRAY转为java数组出错"</span>, e);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure></p>
<h3 id="2、接下来在项目中使用TypeHandler使用"><a href="#2、接下来在项目中使用TypeHandler使用" class="headerlink" title="2、接下来在项目中使用TypeHandler使用"></a>2、接下来在项目中使用TypeHandler使用</h3><h4 id="1）最简单粗暴的方式为在xml文件中直接指定TypeHandler"><a href="#1）最简单粗暴的方式为在xml文件中直接指定TypeHandler" class="headerlink" title="1）最简单粗暴的方式为在xml文件中直接指定TypeHandler"></a>1）最简单粗暴的方式为在xml文件中直接指定TypeHandler</h4><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">username_arr=#&#123;username_arr,typeHandler=xxx.xxx.ArrayTypeHandler&#125;::VARCHAR[]</span><br></pre></td></tr></table></figure>
<h4 id="2）在项目中引入TypeHandler"><a href="#2）在项目中引入TypeHandler" class="headerlink" title="2）在项目中引入TypeHandler"></a>2）在项目中引入TypeHandler</h4><p>在mybatis的配置文件中添加typeHandler标签 如下所示<br><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;typeHandlers&gt;</span><br><span class="line">  &lt;typeHandler handler=<span class="string">"org.mybatis.example.ExampleTypeHandler"</span>/&gt;</span><br><span class="line">&lt;/typeHandlers&gt;</span><br></pre></td></tr></table></figure></p>
<p>然后在自定义Typehandler上添加@MappedTypes和@MappedJdbcTypes注解。例如对于数组类型的TypeHandler，如下所示<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@MappedTypes</span>(&#123;Integer[].class,String[].class,Boolean[].class,Number[].class&#125;)</span><br><span class="line"><span class="meta">@MappedJdbcTypes</span>(value = &#123;JdbcType.ARRAY&#125;,includeNullJdbcType = <span class="keyword">true</span>)</span><br></pre></td></tr></table></figure></p>
<p>然后在对应字段上就可以自动使用typeHandler了,例如用户名数组为位String数组，对应到数据库上就是varchar[],就可以如下使用<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">username_arr=#&#123;username_arr&#125;::VARCHAR[]</span><br></pre></td></tr></table></figure></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  


          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope="" itemtype="http://schema.org/Person">
            
              <p class="site-author-name" itemprop="name">ascetic</p>
              <p class="site-description motion-element" itemprop="description">瑶瑶宝宝最可爱</p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">10</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">6</span>
                  <span class="site-state-item-name">分类</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">8</span>
                  <span class="site-state-item-name">标签</span>
                </a>
              </div>
            

          </nav>

          

          

          
          

          
          

          

        </div>
      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2021</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">ascetic</span>

  
</div>


  <div class="powered-by">由 <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> 强力驱动</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Mist</a> v5.1.4</div>




        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  

  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  













  





  

  

  

  
  

  

  

  

</body>
</html>
